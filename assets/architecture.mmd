graph TD
    User((User)) -->|Interacts| iOS["iOS App (Swift)"]
    iOS -->|HTTPS/REST| API["Backend API (FastAPI)"]
    
    subgraph "Backend Core (Python)"
        API --> Auth["Auth & Wallet Service"]
        API --> AgentRouter["Agent Router"]
        API --> ActionRouter["Card Benefits Engine"]
        
        AgentRouter -->|Background Task| Marathon["Marathon Agent Service"]
        ActionRouter -->|Trigger| Gemini["Gemini Service"]
        
        Marathon -->|Think/Plan| GeminiAI["Google Gemini 3 Flash"]
        Gemini -->|Extract/Analyze| GeminiAI
        
        Marathon -->|Read/Write| Firestore[("Firebase Firestore")]
        Auth -->|Read/Write| Firestore
    end

    subgraph "External"
        GeminiAI -->|Grounding| GoogleSearch["Google Search"]
    end
